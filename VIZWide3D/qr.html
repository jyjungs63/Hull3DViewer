<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- ëª¨ë°”ì¼ ìµœì í™” -->
  <title>QR ì½”ë“œ ìŠ¤ìº” ì˜ˆì œ</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      text-align: center;
      font-family: sans-serif;
      margin: 0;
      padding: 10px;
    }
    h2 {
      font-size: 1.5em;
      margin: 15px 0;
    }
    #reader {
      width: 80%;
      max-width: 300px;     /* ì¡°ê¸ˆ ì‘ê²Œ */
      margin: 0 auto;
      border: 2px solid #ddd;
      border-radius: 10px;
      overflow: hidden;
    }
    #result {
      margin-top: 15px;
      font-size: 1.1em;
      color: green;
      word-break: break-all;
      padding: 5px;
    }
    select {
      margin: 15px auto;
      padding: 12px;
      font-size: 1.2em;       /* ê¸€ì”¨ í¬ê²Œ */
      width: 100%;
      max-width: 400px;
      border-radius: 8px;
      border: 2px solid #888;
      background: #f9f9f9;
      height: 50px;           /* í„°ì¹˜í•˜ê¸° ì¢‹ì€ ë†’ì´ */
    }
  </style>
</head>
<body>
  <h2>ğŸ“· QR ì½”ë“œ ìŠ¤ìº”</h2>
  <select id="cameraSelect"></select>
  <div id="reader"></div>
  <div id="result">QR ì½”ë“œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>

  <script>
    let html5QrCode;
    let currentCameraId;

    // âœ… QR ì½”ë“œ ì¸ì‹ ì„±ê³µ ì‹œ
    function onScanSuccess(decodedText) {
      document.getElementById('result').innerText = `âœ… ì¸ì‹ëœ QR ì½”ë“œ: ${decodedText}`;
    }

    // ì‹¤íŒ¨ ë¡œê·¸
    function onScanFailure(error) {
      console.warn(`QR ì¸ì‹ ì‹¤íŒ¨: ${error}`);
    }

    // âœ… ìŠ¤ìºë„ˆ ì‹œì‘ í•¨ìˆ˜
    function startScanner(cameraId) {
      const qrBoxSize = Math.min(window.innerWidth * 0.8, 300); // ë°˜ì‘í˜• í¬ê¸°

      if (html5QrCode) {
        // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ë©ˆì¶”ê³  ìƒˆ ì¹´ë©”ë¼ë¡œ ì‹œì‘
        html5QrCode.stop().then(() => {
          html5QrCode.start(cameraId, { fps: 10, qrbox: qrBoxSize }, onScanSuccess, onScanFailure);
        }).catch(err => {
          console.error("ì¹´ë©”ë¼ ì „í™˜ ì‹¤íŒ¨:", err);
        });
      } else {
        // ì²˜ìŒ ì‹œì‘í•  ë•Œ Html5Qrcode ê°ì²´ ìƒì„±
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(cameraId, { fps: 10, qrbox: qrBoxSize }, onScanSuccess, onScanFailure);
      }
    }

    // âœ… ìŠ¤ìºë„ˆ ì™„ì „ ì¢…ë£Œ í•¨ìˆ˜ (ì›í•  ë•Œ í˜¸ì¶œ ê°€ëŠ¥)
    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          html5QrCode.clear(); // ì´ë•Œë§Œ clear í˜¸ì¶œ
        }).catch(err => {
          console.error("ìŠ¤ìºë„ˆ ì¢…ë£Œ ì‹¤íŒ¨:", err);
        });
      }
    }

    // âœ… ì¹´ë©”ë¼ ì¥ì¹˜ ê°€ì ¸ì˜¤ê¸°
    Html5Qrcode.getCameras().then(cameras => {
      const select = document.getElementById("cameraSelect");

      cameras.forEach(camera => {
        const option = document.createElement("option");
        option.value = camera.id;
        option.text = camera.label || `ì¹´ë©”ë¼ ${camera.id}`;
        select.appendChild(option);
      });

      // ê¸°ë³¸ ì„ íƒ: í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
      const backCam = cameras.find(cam =>
        cam.label.toLowerCase().includes("back") ||
        cam.label.toLowerCase().includes("rear") ||
        cam.label.toLowerCase().includes("environment")
      );
      currentCameraId = backCam ? backCam.id : cameras[0].id;
      select.value = currentCameraId;

      // ê¸°ë³¸ ì¹´ë©”ë¼ ì‹¤í–‰
      startScanner(currentCameraId);

      // ì‚¬ìš©ìê°€ ì¹´ë©”ë¼ ë³€ê²½ ì‹œ
      select.addEventListener("change", (e) => {
        currentCameraId = e.target.value;
        startScanner(currentCameraId);
      });
    }).catch(err => {
      alert("ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      console.error(err);
    });

    // âœ… í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ QR ë°•ìŠ¤ ìë™ ì¡°ì •
    window.addEventListener("resize", () => {
      if (currentCameraId) {
        startScanner(currentCameraId);
      }
    });
  </script>
</body>
</html>
