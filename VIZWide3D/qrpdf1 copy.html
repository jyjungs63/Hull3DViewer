<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>QR ì½”ë“œ PDF ìë™ ìƒì„±ê¸°</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }

    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 1.8rem;
    }

    .input-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
    }

    input[type="text"], textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      box-sizing: border-box;
    }

    input[type="text"]:focus, textarea:focus {
      border-color: #4285f4;
    }

    textarea {
      height: 100px;
      resize: vertical;
      font-family: monospace;
    }

    button {
      width: 100%;
      margin: 10px 0;
      padding: 15px 20px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      transition: background 0.3s;
    }

    .btn-primary {
      background: #4285f4;
      color: white;
    }

    .btn-primary:hover {
      background: #3367d6;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-info {
      background: #17a2b8;
      color: white;
    }

    .btn-info:hover {
      background: #138496;
    }

    #qrPreview {
      text-align: center;
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      min-height: 100px;
    }

    .hidden {
      display: none;
    }

    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      text-align: center;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .example-data {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 14px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ“„ QR ì½”ë“œ PDF ìë™ ìƒì„±ê¸°</h2>
    
    <div class="input-group">
      <label for="textInput">QR ì½”ë“œì— ë„£ì„ í…ìŠ¤íŠ¸:</label>
      <input type="text" id="textInput" placeholder="URL ë˜ëŠ” í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" value="https://example.com">
    </div>

    <div class="input-group">
      <label for="jsonInput">JSON ë°ì´í„° (ì„ íƒì‚¬í•­):</label>
      <textarea id="jsonInput" placeholder='{"name": "í™ê¸¸ë™", "phone": "010-1234-5678"}'></textarea>
      <button type="button" class="btn-info" onclick="loadExampleData()">ğŸ“‹ ì˜ˆì œ ë°ì´í„° ë¡œë“œ</button>
    </div>

    <button class="btn-primary" onclick="generateAndDownloadPDF()">ğŸš€ QR ì½”ë“œ PDF ë°”ë¡œ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ</button>

    <div id="qrPreview">
      <p>QR ì½”ë“œ ë¯¸ë¦¬ë³´ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
    </div>

    <button class="btn-success hidden" id="downloadBtn" onclick="downloadPDF()">ğŸ“¥ PDF ë‹¤ìš´ë¡œë“œ</button>

    <div id="status"></div>

    <div class="example-data">
ì˜ˆì œ JSON ë°ì´í„°:
{
  "appConfig": {
    "version": "1.0.3",
    "lastUpdated": "2025-09-23T14:25:00+09:00",
    "features": {
      "darkMode": true,
      "notifications": {
        "email": true,
        "sms": false,
        "push": true
      },
      "language": "ko-KR"
    }
  }
}
    </div>
  </div>

  <script>
    let currentPdfBlob = null;
    const users = [
      {
        "appConfig": {
          "version": "1.0.3",
          "lastUpdated": "2025-09-23T14:25:00+09:00",
          "features": {
            "darkMode": true,
            "notifications": {
              "email": true,
              "sms": false,
              "push": true
            },
            "language": "ko-KR"
          }
        },
      }
    ];

    function showStatus(message, type = 'success') {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
      
      // 3ì´ˆ í›„ ë©”ì‹œì§€ ì œê±°
      setTimeout(() => {
        statusDiv.innerHTML = '';
      }, 3000);
    }

    function loadExampleData() {
      document.getElementById('jsonInput').value = JSON.stringify(users[0], null, 2);
      showStatus('ì˜ˆì œ ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    async function generateAndDownloadPDF() {
      try {
        // PDF-lib ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
        if (typeof PDFLib === 'undefined') {
          throw new Error('PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        }

        // QRCode ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
        if (typeof QRCode === 'undefined') {
          throw new Error('QR ì½”ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        }

        showStatus('QR ì½”ë“œì™€ PDFë¥¼ ìƒì„±í•˜ëŠ” ì¤‘...', 'success');
        
        // ì…ë ¥ ë°ì´í„° ì¤€ë¹„
        const textInput = document.getElementById("textInput").value.trim();
        const jsonInput = document.getElementById("jsonInput").value.trim();
        
        let qrData;
        if (jsonInput) {
          try {
            // JSON ìœ íš¨ì„± ê²€ì‚¬
            const parsedJson = JSON.parse(jsonInput);
            qrData = JSON.stringify(parsedJson);
          } catch (e) {
            console.log('JSON íŒŒì‹± ì˜¤ë¥˜:', e);
            showStatus('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.', 'error');
            qrData = jsonInput;
          }
        } else {
          qrData = textInput || "https://example.com";
        }

        console.log('QR ë°ì´í„°:', qrData);

        // ìˆ¨ê²¨ì§„ divì—ì„œ QR ì½”ë“œ ìƒì„±
        const hiddenDiv = document.createElement('div');
        hiddenDiv.id = 'hiddenQR';
        hiddenDiv.style.position = 'absolute';
        hiddenDiv.style.left = '-9999px';
        hiddenDiv.style.top = '-9999px';
        document.body.appendChild(hiddenDiv);

        // QR ì½”ë“œ ìƒì„± (Promiseë¡œ ê°ì‹¸ê¸°)
        const qrDataUrl = await new Promise((resolve, reject) => {
          try {
            console.log('QR ì½”ë“œ ìƒì„± ì‹œì‘');
            
            // ê¸°ì¡´ QR ì½”ë“œ ì œê±°
            hiddenDiv.innerHTML = '';
            
            const qr = new QRCode(hiddenDiv, {
              text: qrData,
              width: 256,
              height: 256,
              colorDark: "#000000",
              colorLight: "#ffffff",
              correctLevel: QRCode.CorrectLevel.H
            });

            // QR ì½”ë“œ ìƒì„± ì™„ë£Œê¹Œì§€ ì¶©ë¶„íˆ ëŒ€ê¸°
            setTimeout(() => {
              try {
                const canvas = hiddenDiv.querySelector('canvas');
                const img = hiddenDiv.querySelector('img');
                
                if (canvas) {
                  console.log('Canvas ë°œê²¬, DataURL ìƒì„±');
                  const dataUrl = canvas.toDataURL("image/png");
                  resolve(dataUrl);
                } else if (img) {
                  console.log('Image ë°œê²¬, src ì‚¬ìš©');
                  resolve(img.src);
                } else {
                  console.error('QR ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', hiddenDiv.innerHTML);
                  reject(new Error('QR ì½”ë“œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
                }
              } catch (err) {
                console.error('QR ì½”ë“œ ì²˜ë¦¬ ì˜¤ë¥˜:', err);
                reject(err);
              }
            }, 500); // ëŒ€ê¸° ì‹œê°„ ì¦ê°€
          } catch (error) {
            console.error('QR ì½”ë“œ ìƒì„± ì˜¤ë¥˜:', error);
            reject(error);
          }
        });

        console.log('QR DataURL ìƒì„± ì™„ë£Œ');

        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        const previewDiv = document.getElementById('qrPreview');
        previewDiv.innerHTML = `
          <h4>ìƒì„±ëœ QR ì½”ë“œ:</h4>
          <img src="${qrDataUrl}" alt="QR Code" style="border: 1px solid #ddd; border-radius: 5px; max-width: 200px;">
          <p style="margin-top: 10px; font-size: 12px; color: #666;">ë°ì´í„°: ${qrData.length > 50 ? qrData.substring(0, 50) + '...' : qrData}</p>
        `;

        // PDF ìƒì„±
        console.log('PDF ìƒì„± ì‹œì‘');
        const { PDFDocument, rgb } = PDFLib;
        const pdfDoc = await PDFDocument.create();
        const page = pdfDoc.addPage([595, 842]); // A4 í¬ê¸°

        console.log('PDF í˜ì´ì§€ ìƒì„± ì™„ë£Œ');

        // ê¸°ë³¸ í°íŠ¸ ì‚¬ìš© (í•œê¸€ ë¬¸ì œ í•´ê²°)
        const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
        const boldFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);

        console.log('í°íŠ¸ ì„ë² ë“œ ì™„ë£Œ');

        // í…ìŠ¤íŠ¸ë¥¼ ASCIIë§Œ ì‚¬ìš©í•˜ë„ë¡ ë³€í™˜
        function toSafeText(text) {
          return text
            .replace(/[ê°€-í£]/g, '?') // í•œê¸€ì„ ?ë¡œ ëŒ€ì²´
            .replace(/[^\x00-\x7F]/g, '?'); // ASCIIê°€ ì•„ë‹Œ ë¬¸ìë¥¼ ?ë¡œ ëŒ€ì²´
        }

        // ì œëª©
        page.drawText("QR Code PDF Document", {
          x: 50,
          y: 750,
          size: 24,
          font: boldFont,
          color: rgb(0, 0, 0),
        });

        // ìƒì„± ë‚ ì§œ
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹
        page.drawText(`Generated: ${dateStr}`, {
          x: 50,
          y: 720,
          size: 12,
          font: font,
          color: rgb(0.5, 0.5, 0.5),
        });

        console.log('PDF í…ìŠ¤íŠ¸ ì‘ì„± ì™„ë£Œ');

        // QR ì½”ë“œ ì´ë¯¸ì§€ ì„ë² ë“œ ë° ì‚½ì…
        try {
          const qrImage = await pdfDoc.embedPng(qrDataUrl);
          const qrSize = 150;
          page.drawImage(qrImage, {
            x: 50,
            y: 500,
            width: qrSize,
            height: qrSize,
          });
          console.log('QR ì´ë¯¸ì§€ ì‚½ì… ì™„ë£Œ');
        } catch (imgError) {
          console.error('QR ì´ë¯¸ì§€ ì‚½ì… ì˜¤ë¥˜:', imgError);
          // QR ì´ë¯¸ì§€ ì‚½ì… ì‹¤íŒ¨ì‹œ í…ìŠ¤íŠ¸ë¡œ ëŒ€ì²´
          page.drawText("QR Code insertion failed", {
            x: 50,
            y: 550,
            size: 12,
            font: font,
            color: rgb(1, 0, 0),
          });
        }

        // QR ì½”ë“œ ì„¤ëª…
        page.drawText("QR Code Data:", {
          x: 220,
          y: 600,
          size: 14,
          font: boldFont,
          color: rgb(0, 0, 0),
        });

        // ë°ì´í„° ë‚´ìš© (ì•ˆì „í•œ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜)
        const safeData = toSafeText(qrData);
        const maxLineLength = 45;
        const lines = [];
        let currentLine = '';
        
        for (let i = 0; i < safeData.length; i++) {
          if (currentLine.length >= maxLineLength || safeData[i] === '\n') {
            lines.push(currentLine);
            currentLine = safeData[i] === '\n' ? '' : safeData[i];
          } else {
            currentLine += safeData[i];
          }
        }
        if (currentLine) lines.push(currentLine);

        // ìµœëŒ€ 15ì¤„ê¹Œì§€ë§Œ í‘œì‹œ
        lines.slice(0, 15).forEach((line, index) => {
          try {
            page.drawText(line || ' ', {
              x: 220,
              y: 580 - (index * 15),
              size: 10,
              font: font,
              color: rgb(0.3, 0.3, 0.3),
            });
          } catch (textError) {
            console.error('í…ìŠ¤íŠ¸ ë Œë”ë§ ì˜¤ë¥˜:', textError, 'Line:', line);
            page.drawText('[Text rendering error]', {
              x: 220,
              y: 580 - (index * 15),
              size: 10,
              font: font,
              color: rgb(1, 0, 0),
            });
          }
        });

        if (lines.length > 15) {
          page.drawText('...more data', {
            x: 220,
            y: 580 - (15 * 15),
            size: 10,
            font: font,
            color: rgb(0.5, 0.5, 0.5),
          });
        }

        // í•˜ë‹¨ ì •ë³´
        page.drawText("This QR code was generated automatically.", {
          x: 50,
          y: 100,
          size: 10,
          font: font,
          color: rgb(0.6, 0.6, 0.6),
        });

        console.log('PDF ë‚´ìš© ì‘ì„± ì™„ë£Œ, ì €ì¥ ì‹œì‘');

        // PDF ì €ì¥
        const pdfBytes = await pdfDoc.save();
        console.log('PDF ë°”ì´ë„ˆë¦¬ ìƒì„± ì™„ë£Œ');
        
        currentPdfBlob = new Blob([pdfBytes], { type: "application/pdf" });

        // ìë™ ë‹¤ìš´ë¡œë“œ
        const link = document.createElement("a");
        link.href = URL.createObjectURL(currentPdfBlob);
        link.download = `qrcode_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
        document.getElementById('downloadBtn').classList.remove('hidden');

        // ìˆ¨ê²¨ì§„ div ì œê±°
        if (document.body.contains(hiddenDiv)) {
          document.body.removeChild(hiddenDiv);
        }

        console.log('PDF ìƒì„± ë° ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
        showStatus('âœ… QR ì½”ë“œ PDFê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì–´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');

      } catch (error) {
        console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
        console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
        showStatus(`âŒ PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
        
        // ìˆ¨ê²¨ì§„ div ì •ë¦¬
        const hiddenDiv = document.getElementById('hiddenQR');
        if (hiddenDiv && document.body.contains(hiddenDiv)) {
          document.body.removeChild(hiddenDiv);
        }
      }
    }

    function downloadPDF() {
      if (currentPdfBlob) {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(currentPdfBlob);
        const now = new Date();
        link.download = `qrcode_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}.pdf`;
        link.click();
        showStatus('ğŸ“¥ PDFê°€ ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
      } else {
        showStatus('âŒ ë‹¤ìš´ë¡œë“œí•  PDFê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.', 'error');
      }
    }

    // í˜ì´ì§€ ë¡œë“œì‹œ ì˜ˆì œ ë°ì´í„° ë¡œë“œ
    window.addEventListener('load', () => {
      console.log('ğŸš€ QR ì½”ë“œ PDF ìƒì„±ê¸°ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!');
    });
  </script>
</body>
</html>