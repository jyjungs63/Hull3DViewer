<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì„ ì²´ 3D ìƒì‚°ë„ë©´</title>
    <!-- jsTree CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css"
    />

    <!-- jQuery (í•„ìˆ˜) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- jsTree JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
    <script src="3dData.js"></script>
    <!-- Three.js + GLTFLoader + OrbitControls -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.min.js",
          "three/examples/jsm/loaders/GLTFLoader.js": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/loaders/GLTFLoader.js",
          "three/examples/jsm/controls/OrbitControls.js": "https://cdn.jsdelivr.net/npm/three@0.169/examples/jsm/controls/OrbitControls.js",
          "three/examples/jsm/loaders/DRACOLoader.js": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/loaders/DRACOLoader.js",
          "three/examples/jsm/environments/RoomEnvironment.js": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/environments/RoomEnvironment.js",
          "three/examples/jsm/postprocessing/EffectComposer.js": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/postprocessing/EffectComposer.js",
          "three/examples/jsm/postprocessing/RenderPass.js": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/postprocessing/RenderPass.js",
          "three/examples/jsm/postprocessing/OutputPass.js": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/postprocessing/OutputPass.js",
          "three/examples/jsm/libs/lil-gui.module.min.js": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/libs/lil-gui.module.min.js",
          "three/examples/jsm/postprocessing/OutlinePass.js": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/postprocessing/OutlinePass.js",
          "three/examples/jsm/postprocessing/UnrealBloomPass.js": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/postprocessing/UnrealBloomPass.js"
        }
      }
    </script>
    <style>

    </style>
  </head>
  <body>
    <div class="container">
      <div class="menubar">
        <h3>ğŸ“ Assembly</h3>
        <div class="menu-controls">
          <button class="menu-btn" onclick="resetLayout()">ğŸ”„ Reset</button>
          <button class="menu-btn" onclick="toggleFullscreen()">
            â›¶ Fullscreen
          </button>
          <button class="menu-btn" onclick="saveLayout()">ğŸ’¾ Save</button>
        </div>
      </div>

      <div class="main-content">
        <div class="left-panel" id="leftPanel">
          <button class="toggle-btn" onclick="toggleLeftPanel()">â—€</button>
          <div class="panel-content" style="display: flex; flex-direction: column; height: 100%; align-items: center;">
            <!-- ê²€ìƒ‰ í¼ (width 80%) -->
            <div style="flex: none; width: 90%; padding: 10px 12px; border-bottom: 1px solid #ddd">
              <form id="searchForm" onsubmit="return false;" style="width: 100%;">
                <!-- ìŠ¹ì„  -->
                <div style="margin-bottom: 10px">
                  <label style="display: block; font-weight: bold; margin-bottom: 5px; font-size: 12px;">í˜¸ì„ </label>
                  <div style="display: flex; gap: 5px">
                    <input type="text" id="ìŠ¹ì„ " placeholder="201" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; min-width: 0;" />
                    <button type="button" onclick="searchìŠ¹ì„ ()" style="padding: 8px 12px; background: white; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; flex-shrink: 0;">â˜°</button>
                  </div>
                </div>

                <!-- ì„¤ê³„ë¶€ì„œ -->
                <div style="margin-bottom: 10px">
                  <label style="display: block; font-weight: bold; margin-bottom: 5px; font-size: 12px;">ë¸”ëŸ­</label>
                  <div style="display: flex; gap: 5px">
                    <input type="text" id="ì„¤ê³„ë¶€ì„œ" placeholder="F212C" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; min-width: 0;" />
                    <button type="button" onclick="selectì„¤ê³„ë¶€ì„œ()" style="padding: 8px 12px; background: white; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; flex-shrink: 0;">ğŸ”</button>
                  </div>
                </div>

                <!-- ë„ë©´ë²ˆí˜¸ -->
                <div style="margin-bottom: 10px">
                  <label style="display: block; font-weight: bold; margin-bottom: 5px; font-size: 12px;">ë„ë©´ë²ˆí˜¸</label>
                  <div style="display: flex; gap: 5px">
                    <input type="text" id="ë„ë©´ë²ˆí˜¸" placeholder="" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; min-width: 0;" />
                    <button type="button" onclick="searchë„ë©´ë²ˆí˜¸()" style="padding: 8px 12px; background: white; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; flex-shrink: 0;">ğŸ”</button>
                  </div>
                </div>

                <!-- ë„ë©´ëª… -->
                <div style="margin-bottom: 10px">
                  <label style="display: block; font-weight: bold; margin-bottom: 5px; font-size: 12px;">ë„ë©´ëª…</label>
                  <input type="text" id="ë„ë©´ëª…" placeholder="" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;" />
                </div>
              </form>
            </div>

            <!-- jsTree (ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€) -->
            <div id="jstree" style="flex: 1; overflow: auto; padding: 0px" ></div>
          </div>
          <div class="resizer resizer-h-thin" data-resize="left"></div>
        </div>

        <div class="center-panel">
          <div class="top-row">
            <div id="view1" class="view-panel"></div>
            <div class="resizer resizer-v-between" data-resize="view1-h"></div>
            <div id="view2" class="view-panel">
              <!-- <div class="resizer resizer-v-thin" data-resize="view1-v"></div> -->
            </div>
          </div>
          <div class="resizer resizer-v" data-resize="topRow"></div>

          <div class="bottom-row">
            <div id="view3" class="view-panel"></div>
            <div class="resizer resizer-v-between" data-resize="view3-h"></div>
            <div id="images" class="view-panel">

            </div>
          </div>
        </div>

        <div class="right-panel" id="rightPanel">
          <div class="right-top" id="rightTop"> 
              <iframe src="index_view.html" style="width: 100%; height: 100%; border: none;"  > </iframe>
              <div class="resizer resizer-v-thin" data-resize="rightTop"></div>
          </div>
          
          <div class="right-bottom">Property Sheet</div>
        </div>
      </div>

      <div class="console" id="console">
        <div class="console-resizer" id="consoleResizer"></div>
        <div id="myconsole">
          <div class="console-header">
            <span></span>
            <button class="toggle-btn" onclick="toggleConsole()">â–¼</button>
          </div>
          <div class="console-content" style="margin-top: -30px"></div>
        </div>
      </div>
    </div>
    <link rel="stylesheet" href="VIZCore3D/Resource/css/VIZCore.css">
    <script type="module">
      import * as THREE from "three";
      import { GLTFLoader } from "three/examples/jsm/loaders/GLTFLoader.js";
      import { OrbitControls } from "three/examples/jsm/controls/OrbitControls.js";
      import { DRACOLoader } from "three/examples/jsm/loaders/DRACOLoader.js";


      const models = {
        view1: "mipoTest/F201.glb",
        view2: "mipoTest/E21P_BLOCK.glb",
        view3: "mipoTest/E22P_BLOCK.glb",
      };

      // 3D ë·° ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì €ì¥í•  ê°ì²´
      const threeViews = {};

      let isResizing = false;
      let currentResizer = null;
      let startX = 0;
      let startY = 0;
      let startWidth = 0;
      let startHeight = 0;


      const resizers = document.querySelectorAll(
        ".resizer, .resizer-h-thin, .resizer-v-thin, .resizer-v-between"
      );

      resizers.forEach((resizer) => {
        resizer.addEventListener("mousedown", initResize);
      });

      // Right panel resizer
      const rightPanel = document.getElementById("rightPanel");
      rightPanel.addEventListener("mousedown", (e) => {
        const rect = rightPanel.getBoundingClientRect();
        if (e.clientX >= rect.left - 2 && e.clientX <= rect.left + 2) {
          e.preventDefault();
          isResizing = true;
          startX = e.clientX;
          startWidth = rightPanel.offsetWidth;
          currentResizer = { dataset: { resize: "right" } };
          rightPanel.classList.add("active");
          document.addEventListener("mousemove", resize);
          document.addEventListener("mouseup", stopResize);
        }
      });

      // Console resizer
      const consoleResizer = document.getElementById("consoleResizer");
      consoleResizer.addEventListener("mousedown", (e) => {
        e.preventDefault();
        isResizing = true;
        startY = e.clientY;
        const consoleEl = document.getElementById("console");
        startHeight = consoleEl.offsetHeight;
        currentResizer = { dataset: { resize: "console" } };
        consoleResizer.classList.add("active");
        document.addEventListener("mousemove", resize);
        document.addEventListener("mouseup", stopResize);
      });

      window.toggleConsole = function () {
        const consoleEl = document.getElementById("console");
        const btn = consoleEl.querySelector(".toggle-btn");
        consoleEl.classList.toggle("collapsed");
        btn.textContent = consoleEl.classList.contains("collapsed") ? "â–²" : "â–¼";

        // ì½˜ì†” í¬ê¸° ë³€ê²½ ì‹œ 3D ë·° ì—…ë°ì´íŠ¸
        setTimeout(() => updateAllViews(), 50);
      };

      window.toggleLeftPanel = function () {
        const leftPanel = document.getElementById("leftPanel");
        const btn = leftPanel.querySelector(".toggle-btn");
        leftPanel.classList.toggle("collapsed");
        btn.textContent = leftPanel.classList.contains("collapsed") ? "â–¶" : "â—€";
        const form = document.getElementById("searchForm");
        form.style.display = leftPanel.classList.contains("collapsed") ? "none" : "block";
        
        const tree = document.getElementById("jstree");
        tree.style.display = leftPanel.classList.contains("collapsed") ? "none" : "block";

        // íŒ¨ë„ í† ê¸€ ì‹œ 3D ë·° ì—…ë°ì´íŠ¸
        setTimeout(() => updateAllViews(), 50);
      };

      function initResize(e) {
        isResizing = true;
        currentResizer = e.target;
        startX = e.clientX;
        startY = e.clientY;

        currentResizer.classList.add("active");

        const resizeType = currentResizer.dataset.resize;

        if (resizeType === "left") {
          startWidth = document.getElementById("leftPanel").offsetWidth;
        } else if (resizeType === "right") {
          startWidth = document.getElementById("rightPanel").offsetWidth;
        } else if (resizeType === "topRow") {
          const topRow = document.querySelector(".top-row");
          startHeight = topRow.offsetHeight;
        } else if (resizeType === "rightTop") {
          startHeight = document.getElementById("rightTop").offsetHeight;
        } else if (resizeType === "view1-h") {
          startWidth = document.getElementById("view1").offsetWidth;
        } else if (resizeType === "view1-v") {
          startHeight = document.querySelector(".top-row").offsetHeight;
        } else if (resizeType === "view3-h") {
          startWidth = document.getElementById("view3").offsetWidth;
        } else if (resizeType === "view3-v") {
          startHeight = document.querySelector(".bottom-row").offsetHeight;
        }

        document.addEventListener("mousemove", resize);
        document.addEventListener("mouseup", stopResize);

        e.preventDefault();
      }
      function resize(e) {
        if (!isResizing) return;

        const resizeType = currentResizer.dataset.resize;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        const setWidth = (el, width, min = 100, max = Infinity) => {
          if (width > min && width < max) {
            el.style.flex = "none";
            el.style.width = width + "px";
          }
        };

        const setHeight = (el, height, min = 100, max = Infinity) => {
          if (height > min && height < max) {
            el.style.flex = "none";
            el.style.height = height + "px";
          }
        };

        switch (resizeType) {
          // ì™¼ìª½ íŒ¨ë„ ë¦¬ì‚¬ì´ì¦ˆ
          case "left": {
            const newWidth = startWidth + dx;
            setWidth(document.getElementById("leftPanel"), newWidth);
            break;
          }

          // ì˜¤ë¥¸ìª½ íŒ¨ë„ ë¦¬ì‚¬ì´ì¦ˆ
          case "right": {
            const newWidth = startWidth - dx;
            setWidth(document.getElementById("rightPanel"), newWidth, 150);
            break;
          }

          // ì½˜ì†” ì˜ì—­ ìˆ˜ì§ ë¦¬ì‚¬ì´ì¦ˆ
          case "console": {
            const consoleEl = document.getElementById("console");
            const newHeight = startHeight - dy;
            setHeight(consoleEl, newHeight, 30, 500);
            break;
          }

          // ìƒë‹¨ í–‰ ë¦¬ì‚¬ì´ì¦ˆ
          case "topRow": {
            const topRow = document.querySelector(".top-row");
            const newHeight = startHeight + dy;
            setHeight(topRow, newHeight);
            break;
          }

          // ì˜¤ë¥¸ìª½ ìƒë‹¨ ì˜ì—­ ë¦¬ì‚¬ì´ì¦ˆ
          case "rightTop": {
            const rightTop = document.getElementById("rightTop");
            const newHeight = startHeight + dy;
            setHeight(rightTop, newHeight);
            break;
          }

          // view1ê³¼ view2 ì‚¬ì´ ìˆ˜í‰ ë¦¬ì‚¬ì´ì¦ˆ
          case "view1-h": {
            const view1 = document.getElementById("view1");
            const view2 = document.getElementById("view2");
            const container = view1.parentElement; // top-row
            const totalWidth = container.clientWidth;
            const newWidth = startWidth + dx;
            const newView2Width = totalWidth - newWidth;

            if (newWidth > 150 && newView2Width > 150) {
              setWidth(view1, newWidth);
              // view2ë„ ëª…ì‹œì ìœ¼ë¡œ í¬ê¸° ì„¤ì •
              setWidth(view2, newView2Width);
            }
            break;
          }

          // view1 ìˆ˜ì§ ë¦¬ì‚¬ì´ì¦ˆ (ìƒë‹¨ ë†’ì´ ì¡°ì •)
          case "view1-v": {
            const topRow = document.querySelector(".top-row");
            const newHeight = startHeight + dy;
            setHeight(topRow, newHeight);
            break;
          }

          // view3ê³¼ rightTop ì‚¬ì´ ìˆ˜í‰ ë¦¬ì‚¬ì´ì¦ˆ
          case "view3-h": {
            const view3 = document.getElementById("view3");
            const rightTop = document.getElementById("rightTop");
            const totalWidth = view3.offsetWidth + rightTop.offsetWidth;
            const newWidth = startWidth + dx;

            if (newWidth > 150 && totalWidth - newWidth > 150) {
              setWidth(view3, newWidth);
              rightTop.style.flex = "1";
              void rightTop.offsetWidth;
            }
            break;
          }

          // view3 ìˆ˜ì§ ë¦¬ì‚¬ì´ì¦ˆ (í•˜ë‹¨ ë†’ì´ ì¡°ì •)
          case "view3-v": {
            const bottomRow = document.querySelector(".bottom-row");
            const newHeight = startHeight + dy;
            setHeight(bottomRow, newHeight);
            break;
          }
        }

        // ë¦¬ì‚¬ì´ì¦ˆ ì¤‘ 3D ë·° ì—…ë°ì´íŠ¸
        updateAllViews();
      }

      function stopResize() {
        if (isResizing) {
          isResizing = false;
          if (currentResizer && currentResizer.classList) {
            currentResizer.classList.remove("active");
          }
          document.getElementById("rightPanel").classList.remove("active");
          document.getElementById("consoleResizer").classList.remove("active");
          currentResizer = null;
          document.removeEventListener("mousemove", resize);
          document.removeEventListener("mouseup", stopResize);

          // ë¦¬ì‚¬ì´ì¦ˆ ì™„ë£Œ í›„ ìµœì¢… ì—…ë°ì´íŠ¸
          updateAllViews();
        }
      }

      // ëª¨ë“  3D ë·° ì—…ë°ì´íŠ¸
      function updateAllViews() {
        Object.keys(threeViews).forEach((viewId) => {
          updateView(viewId);
        });
      }

      // íŠ¹ì • 3D ë·° ì—…ë°ì´íŠ¸
      function updateView(viewId) {
        const view = threeViews[viewId];
        if (!view) return;

        const container = document.getElementById(viewId);
        const width = container.clientWidth;
        const height = container.clientHeight;
        if (viewId === "view1") {
          console.log(`Updating view ${viewId}: ${width}x${height}`);
        }
        view.camera.aspect = width / height;
        view.camera.updateProjectionMatrix();
        view.renderer.setSize(width, height);
      }

      function initThreeView(viewId, modelPath) {
        const container = document.getElementById(viewId);
        container.innerHTML = "";

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf0f0f0);

        const camera = new THREE.PerspectiveCamera( 45, container.clientWidth / container.clientHeight, 0.1, 1000 );
        camera.position.set(2, 2, 2);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        const light = new THREE.HemisphereLight(0xffffff, 0x444444);
        light.position.set(1, 1, 1);
        scene.add(light);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(2, 2, 2);
        scene.add(directionalLight);

        // ë·° ì •ë³´ ì €ì¥
        threeViews[viewId] = { scene, camera, renderer, controls, };

        const loader = new GLTFLoader();
        const dracoLoader = new DRACOLoader();
        dracoLoader.setDecoderPath(
          "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/libs/draco/"
        );
        loader.setDRACOLoader(dracoLoader);

        loader.load(
          modelPath,
          function (gltf) {
            const model = gltf.scene;
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());

            scene.add(model);

            const size = box.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            const fitDistance = maxDim * 1.5;
            camera.position.set(
              center.x + fitDistance,
              center.y + fitDistance,
              center.z + fitDistance
            );
            camera.lookAt(center);
            controls.target.copy(center);

            animate();
          },
          undefined,
          function (error) {
            console.error(`Error loading ${modelPath}:`, error);
          }
        );

        function animate() {
          requestAnimationFrame(animate);
          controls.update();
          renderer.render(scene, camera);
        }
      }

      // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸
      window.addEventListener("resize", () => {
        updateAllViews();
      });

      // 3D ë·° ì´ˆê¸°í™”
      initThreeView("view1", models.view1);
      logToConsole("view1 ì´ˆê¸°í™”", "info");

      initThreeView("images", models.view2);
      logToConsole("view2 ì´ˆê¸°í™”", "info");

      initThreeView("view3", models.view3);
      logToConsole("view3 ì´ˆê¸°í™”", "info");

      displayGLBTable("view2", 4);
      logToConsole("Images ì´ˆê¸°í™” ì™„ë£Œ", "success");
      // jsTree ì´ˆê¸°í™”
      $(function () {
        $("#jstree")
          .jstree({
            core: {
              data: treeData,
            },
            plugins: ["state"], // ì„ íƒì‚¬í•­: ìƒíƒœ ì €ì¥
          })
          .on("ready.jstree", function () {
            $(this).jstree("open_all");
          })
          .on("select_node.jstree", function (e, data) {
            const node = data.node;
            logToConsole(`ë…¸ë“œ ì„ íƒ: ${node.text}`, "warning");
            // ì„ íƒëœ ë…¸ë“œì— ë”°ë¼ 3D ë·° ì—…ë°ì´íŠ¸ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
          });
      });
    </script>
  </body>
</html>