<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Windows ì¸ì¦ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</title>
<style>
  body { font-family: system-ui, -apple-system, "ë‚˜ëˆ”ê³ ë”•", "Noto Sans KR", Arial; padding: 18px; line-height:1.5; }
  button { padding: 8px 12px; border-radius:6px; border:1px solid #ccc; background:#f6f6f6; cursor:pointer; }
  pre { background:#111; color:#eee; padding:12px; border-radius:6px; max-width:100%; overflow:auto; }
  .meta { margin-bottom:12px; color:#666; font-size:0.95rem; }
  .warn { color:#a33; font-weight:600; }
  .ok { color:#177; font-weight:600; }
</style>
</head>
<body>
  <h2>Windows ì¸ì¦ (IWA) ë¡œê·¸ì¸ í™•ì¸</h2>

  <div class="meta">
    <div>âš ï¸ <span class="warn">ë¡œì»¬ íŒŒì¼ë¡œ ì—´ë©´ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span> ì›¹ì„œë²„(ì˜ˆ: IIS / Node)ì—ì„œ ì œê³µë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</div>
    <div>ğŸ’¡ ë¸Œë¼ìš°ì € ì„¤ì •: Chrome/EdgeëŠ” Intranet zoneì—ì„œ "ìë™ìœ¼ë¡œ Windows ìê²©ì¦ëª… ì „ì†¡"ì´ í—ˆìš©ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</div>
  </div>

  <div style="display:flex; gap:10px; align-items:center; margin-bottom:12px;">
    <button id="btnLogin">ë¡œê·¸ì¸ í™•ì¸</button>
    <button id="btnAuto">ìë™ ê²€ì‚¬ ì¼œê¸°</button>
    <span id="status" class="meta"></span>
  </div>

  <pre id="result">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</pre>

<script>
const resultEl = document.getElementById('result');
const statusEl = document.getElementById('status');
const btn = document.getElementById('btnLogin');
const btnAuto = document.getElementById('btnAuto');

let autoInterval = null;

function setStatus(text, ok) {
  statusEl.textContent = text;
  statusEl.className = ok ? 'meta ok' : 'meta warn';
}

async function checkLogin() {
  setStatus('ìš”ì²­ ì¤‘â€¦', true);
  resultEl.textContent = '';

  // ê²½ë¡œëŠ” ì„œë²„ì¸¡ ì—”ë“œí¬ì¸íŠ¸ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”
  const url = '/api/login';

  try {
    const res = await fetch(url, {
      method: 'GET',
      credentials: 'include', // ì¤‘ìš”: IWA í† í° ì „ì†¡ì„ ìœ„í•´ í•„ìš”
      // mode: 'same-origin' // cross-originì´ë¼ë©´ ì„œë²„ì™€ CORS/credentials ì„¤ì • í•„ìš”
    });

    let bodyText = await res.text();
    let parsed = null;
    try { parsed = JSON.parse(bodyText); } catch (e){ /* not json */ }

    if (res.ok) {
      setStatus(`ì¸ì¦ë¨ (HTTP ${res.status})`, true);
      if (parsed) {
        // user í•„ë“œê°€ "DOMAIN\\username" í˜•íƒœë¼ ê°€ì •í•˜ê³  ë¶„ë¦¬
        const userRaw = parsed.user || parsed.username || '';
        let domain = '', username = userRaw;
        if (typeof userRaw === 'string' && userRaw.includes('\\')) {
          [domain, username] = userRaw.split('\\');
        }
        const out = {
          httpStatus: res.status,
          userRaw,
          domain,
          username,
          groups: parsed.groups || parsed.userGroups || null,
          fullResponse: parsed
        };
        resultEl.textContent = JSON.stringify(out, null, 2);
      } else {
        // non-json body
        resultEl.textContent = `ì„œë²„ ì‘ë‹µ(ë¹„-JSON):\n\n${bodyText}`;
      }
    } else if (res.status === 401) {
      setStatus(`ì¸ì¦ë˜ì§€ ì•ŠìŒ (HTTP 401)`, false);
      resultEl.textContent = parsed ? JSON.stringify(parsed, null, 2) : bodyText;
    } else {
      setStatus(`ì˜¤ë¥˜ (HTTP ${res.status})`, false);
      resultEl.textContent = parsed ? JSON.stringify(parsed, null, 2) : bodyText;
    }
  } catch (err) {
    setStatus('ìš”ì²­ ì‹¤íŒ¨', false);
    resultEl.textContent = `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” CORS/ë¸Œë¼ìš°ì € ì„¤ì • ë¬¸ì œ:\n\n${err.toString()}\n\nì°¸ê³ : IWAëŠ” ëŒ€ê°œ Intranet(ì‚¬ë‚´) í™˜ê²½ì—ì„œë§Œ ë™ì‘í•©ë‹ˆë‹¤.`;
  }
}

// ë²„íŠ¼ ì´ë²¤íŠ¸
btn.addEventListener('click', checkLogin);

// ìë™ ê²€ì‚¬ í† ê¸€ (ì˜ˆ: 30ì´ˆ ê°„ê²©)
btnAuto.addEventListener('click', () => {
  if (!autoInterval) {
    autoInterval = setInterval(checkLogin, 30000);
    btnAuto.textContent = 'ìë™ ê²€ì‚¬ ë„ê¸°';
    setStatus('ìë™ ê²€ì‚¬ í™œì„±í™” (30s)', true);
    checkLogin();
  } else {
    clearInterval(autoInterval);
    autoInterval = null;
    btnAuto.textContent = 'ìë™ ê²€ì‚¬ ì¼œê¸°';
    setStatus('ìë™ ê²€ì‚¬ ë¹„í™œì„±í™”', true);
  }
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ(ì˜µì…˜): ìë™ 1íšŒ í˜¸ì¶œ
window.addEventListener('load', () => {
  if (location.protocol === 'file:') {
    setStatus('íŒŒì¼ í”„ë¡œí† ì½œë¡œ ì—´ë¦¼ â€” ì„œë²„ì—ì„œ ì œê³µí•´ì•¼ ì‘ë™í•©ë‹ˆë‹¤.', false);
    resultEl.textContent = 'ì´ íŒŒì¼ì„ ì›¹ì„œë²„(IIS/Node ë“±)ë¡œ ì„œë¹™í•œ ë’¤ ì ‘ê·¼í•˜ì„¸ìš”.';
    return;
  }
  // ìë™ 1íšŒ ì²´í¬ (ì›í•˜ì§€ ì•Šìœ¼ë©´ ì£¼ì„ ì²˜ë¦¬)
  checkLogin();
});
</script>
</body>
</html>
